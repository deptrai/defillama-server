-- Migration: Create transaction_vulnerability_assessments table
-- Story: 4.1.2 - MEV Protection Insights
-- Date: 2025-10-16
-- Description: Stores transaction vulnerability assessments and protection recommendations

-- ============================================================================
-- Table: transaction_vulnerability_assessments
-- ============================================================================

CREATE TABLE IF NOT EXISTS transaction_vulnerability_assessments (
  -- Primary Key
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Transaction Info
  tx_hash VARCHAR(255),  -- Optional: null for pre-submission analysis
  user_address VARCHAR(255) NOT NULL,
  chain_id VARCHAR(50) NOT NULL,
  timestamp TIMESTAMP NOT NULL DEFAULT NOW(),
  
  -- Token Info
  token_in_address VARCHAR(255),
  token_out_address VARCHAR(255),
  amount_in DECIMAL(30, 10),
  amount_out DECIMAL(30, 10),
  slippage_tolerance DECIMAL(5, 2),  -- Percentage (e.g., 0.50 for 0.5%)
  
  -- Vulnerability Scores
  vulnerability_score DECIMAL(5, 2) NOT NULL,  -- 0-100
  risk_category VARCHAR(20) NOT NULL,  -- low, medium, high, critical
  sandwich_risk DECIMAL(5, 2),  -- 0-100
  frontrun_risk DECIMAL(5, 2),  -- 0-100
  backrun_risk DECIMAL(5, 2),  -- 0-100
  
  -- Estimated Impact
  estimated_mev_loss_usd DECIMAL(20, 2),
  estimated_slippage_pct DECIMAL(5, 2),
  
  -- Protection Recommendations
  recommended_slippage DECIMAL(5, 2),
  recommended_gas_price DECIMAL(10, 2),  -- Gwei
  use_private_mempool BOOLEAN DEFAULT FALSE,
  use_mev_protection_rpc BOOLEAN DEFAULT FALSE,
  
  -- Alternative Routes (JSONB)
  alternative_routes JSONB,  -- Array of {dex, price_impact, gas_cost, mev_risk, total_cost}
  
  -- Simulation Results (JSONB)
  simulation_results JSONB,  -- {worst_case, best_case, expected_case}
  
  -- Metadata
  created_at TIMESTAMP DEFAULT NOW()
);

-- ============================================================================
-- Indexes
-- ============================================================================

-- Index on user_address for user-specific queries
CREATE INDEX IF NOT EXISTS idx_vulnerability_assessments_user 
ON transaction_vulnerability_assessments(user_address);

-- Index on timestamp for time-based queries (DESC for recent first)
CREATE INDEX IF NOT EXISTS idx_vulnerability_assessments_timestamp 
ON transaction_vulnerability_assessments(timestamp DESC);

-- Index on risk_category for filtering by risk level
CREATE INDEX IF NOT EXISTS idx_vulnerability_assessments_risk 
ON transaction_vulnerability_assessments(risk_category);

-- Index on vulnerability_score for sorting by score (DESC for highest first)
CREATE INDEX IF NOT EXISTS idx_vulnerability_assessments_score 
ON transaction_vulnerability_assessments(vulnerability_score DESC);

-- ============================================================================
-- Comments
-- ============================================================================

COMMENT ON TABLE transaction_vulnerability_assessments IS 
'Stores transaction vulnerability assessments and MEV protection recommendations';

COMMENT ON COLUMN transaction_vulnerability_assessments.vulnerability_score IS 
'Overall vulnerability score (0-100): weighted average of sandwich (50%), frontrun (30%), backrun (20%)';

COMMENT ON COLUMN transaction_vulnerability_assessments.risk_category IS 
'Risk category: low (0-30), medium (31-60), high (61-80), critical (81-100)';

COMMENT ON COLUMN transaction_vulnerability_assessments.alternative_routes IS 
'Array of alternative DEX routes with risk/cost analysis';

COMMENT ON COLUMN transaction_vulnerability_assessments.simulation_results IS 
'Simulation results for worst case, best case, and expected case scenarios';

