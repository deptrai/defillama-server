# DeFiLlama Server - Development Guide

*Generated by BMAD Method v6.0.0-alpha.0 on 2025-10-13*

## 🚀 Quick Start

### Prerequisites

**Required Software**:
- **Node.js**: v16+ (v18+ recommended for defi service, v16+ for coins service)
- **npm**: v8+ (comes with Node.js)
- **AWS CLI**: v2+ configured with credentials
- **Git**: v2.30+ with submodule support

**Optional but Recommended**:
- **PostgreSQL**: v13+ for local database development
- **Redis**: v6+ for local caching (coins service)
- **Docker**: v20+ for containerized development

### Environment Setup

1. **Clone Repository**
```bash
git clone https://github.com/DefiLlama/defillama-server.git
cd defillama-server

# Initialize submodules (important!)
git submodule update --init --recursive
```

2. **AWS Configuration**
```bash
# Configure AWS CLI
aws configure

# Or set environment variables
export AWS_ACCESS_KEY_ID=your_access_key
export AWS_SECRET_ACCESS_KEY=your_secret_key
export AWS_REGION=eu-central-1
```

3. **Environment Variables**
```bash
# Create .env files for each service
# defi/.env
AWS_REGION=eu-central-1
tableName=dev-table
NODE_ENV=dev

# coins/.env  
AWS_REGION=eu-central-1
tableName=dev-coins-table
NODE_ENV=dev
```

## 🏗️ Service Development

### DeFi Service Development

**Setup**:
```bash
cd defi
npm install

# Build and check for type errors
npm run prebuild

# Run tests
npm test

# Start local development server
npm run serve
```

**Key Scripts**:
```bash
# Development
npm run serve              # Start local server (port 3000)
npm run api2-dev          # Start API v2 development server
npm test                  # Run test suite
npm run format            # Format code with Prettier

# Building & Deployment
npm run prebuild          # Generate protocols and build cache
npm run build             # Package for deployment
npm run deploy:dev        # Deploy to dev environment
npm run deploy:prod       # Deploy to production

# Data Management
npm run update-submodules # Update adapter submodules
npm run fillOld           # Backfill historical data
npm run clear-cache       # Clear protocol cache
```

**Development Server**:
- **URL**: http://localhost:3000
- **Hot Reload**: ✅ Enabled
- **API Endpoints**: All production endpoints available locally
- **Database**: Uses AWS DynamoDB (configure table name)

### Coins Service Development

**Setup**:
```bash
cd coins
npm install

# Run tests
npm test

# Start local development server
npm run serve
```

**Key Scripts**:
```bash
# Development
npm run serve             # Start local server (port 3001)
npm test                 # Run test suite
npm run test-coin        # Test specific coin functionality
npm run format           # Format code with Prettier

# Building & Deployment
npm run build            # Package for deployment
npm run deploy:prod      # Deploy to production

# Data Operations
npm run fetch-cg-hourly  # Fetch CoinGecko data (hourly)
npm run fetch-cg-min     # Fetch CoinGecko data (minutely)
npm run store-defi-coins # Store DeFi coin data
npm run refill           # Refill price data
```

**Development Server**:
- **URL**: http://localhost:3001
- **Hot Reload**: ✅ Enabled
- **Cache**: Uses local Redis if available, falls back to memory
- **Database**: Uses AWS DynamoDB (configure table name)

## 🧪 Testing

### Test Structure

```
defi/
├── src/
│   ├── __tests__/          # Unit tests
│   ├── api/
│   │   └── __tests__/      # API tests
│   └── protocols/
│       └── __tests__/      # Protocol tests
└── jest.config.js

coins/
├── src/
│   ├── __tests__/          # Unit tests
│   └── adapters/
│       └── __tests__/      # Adapter tests
└── jest.config.js
```

### Running Tests

**DeFi Service**:
```bash
cd defi

# Run all tests
npm test

# Run tests in watch mode
npm run test:watch

# Run specific test file
npm test -- protocols/ethereum

# Run tests with coverage
npm test -- --coverage
```

**Coins Service**:
```bash
cd coins

# Run all tests
npm test

# Run tests in watch mode
npm run test:watch

# Test specific coin functionality
npm run test-coin

# Run with local test environment
LOCAL_TEST=true npm run test-coin
```

### Test Configuration

**Jest Configuration** (`jest.config.js`):
```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  setupFilesAfterEnv: ['<rootDir>/src/setupTests.ts'],
  testMatch: ['**/__tests__/**/*.test.ts'],
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
    '!src/__tests__/**'
  ]
};
```

## 🔧 Development Workflow

### Code Style & Formatting

**Prettier Configuration**:
```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2
}
```

**TypeScript Configuration**:
```json
{
  "compilerOptions": {
    "target": "es2019",
    "module": "esnext",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": false,
    "forceConsistentCasingInFileNames": true
  }
}
```

### Git Workflow

**Branch Strategy**:
- `main` - Production branch
- `dev` - Development branch  
- `feature/*` - Feature branches
- `hotfix/*` - Hotfix branches

**Commit Convention**:
```bash
# Format: type(scope): description
feat(defi): add new protocol adapter
fix(coins): resolve price calculation bug
docs(readme): update setup instructions
refactor(api): optimize database queries
```

### Submodule Management

**Update Adapters**:
```bash
# Update all submodules
npm run update-submodules

# Update specific submodule
cd DefiLlama-Adapters
git checkout main
git pull origin main
cd ..
git add DefiLlama-Adapters
git commit -m "update: DefiLlama-Adapters to latest"
```

## 🐛 Debugging

### Local Debugging

**VS Code Configuration** (`.vscode/launch.json`):
```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug DeFi Service",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/defi/node_modules/.bin/serverless",
      "args": ["offline", "start"],
      "cwd": "${workspaceFolder}/defi",
      "env": {
        "NODE_ENV": "development"
      }
    }
  ]
}
```

**Debug Scripts**:
```bash
# Debug with Node.js inspector
node --inspect-brk node_modules/.bin/serverless offline start

# Debug specific function
node --inspect-brk node_modules/.bin/ts-node src/cli/interactive.ts

# Debug with additional logging
DEBUG=* npm run serve
```

### Production Debugging

**CloudWatch Logs**:
```bash
# View logs for specific function
aws logs tail /aws/lambda/defillama-dev-api --follow

# Filter logs by error level
aws logs filter-log-events \
  --log-group-name /aws/lambda/defillama-dev-api \
  --filter-pattern "ERROR"
```

**X-Ray Tracing**:
- Enable X-Ray in serverless.yml
- View traces in AWS X-Ray console
- Analyze performance bottlenecks

## 📊 Performance Optimization

### Database Optimization

**DynamoDB Best Practices**:
```typescript
// Efficient query patterns
const params = {
  TableName: tableName,
  KeyConditionExpression: 'PK = :pk AND SK BETWEEN :start AND :end',
  ExpressionAttributeValues: {
    ':pk': `protocol#${protocolId}`,
    ':start': startTimestamp,
    ':end': endTimestamp
  },
  ScanIndexForward: false, // Latest first
  Limit: 100
};
```

**PostgreSQL Optimization**:
```sql
-- Add indexes for common queries
CREATE INDEX idx_prices_timestamp ON prices(timestamp DESC);
CREATE INDEX idx_protocols_category ON protocols(category);

-- Use connection pooling
const pool = new Pool({
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000
});
```

### Caching Strategies

**Redis Caching**:
```typescript
// Price caching with TTL
await redis.setex(`price:${tokenId}`, 30, JSON.stringify(priceData));

// Batch operations
const pipeline = redis.pipeline();
prices.forEach(price => {
  pipeline.setex(`price:${price.id}`, 30, JSON.stringify(price));
});
await pipeline.exec();
```

### Lambda Optimization

**Memory & Timeout Configuration**:
```yaml
functions:
  api:
    handler: src/handler.api
    memorySize: 1024  # Adjust based on workload
    timeout: 30       # Maximum 30 seconds
    reservedConcurrency: 100  # Limit concurrent executions
```

## 🚀 Deployment

### Development Deployment

```bash
# Deploy to development environment
cd defi
npm run deploy:dev

cd ../coins  
npm run deploy:prod  # Coins only has prod stage
```

### Production Deployment

```bash
# Deploy to production
cd defi
export NODE_ENV=prod
npm run deploy:prod

# Monitor deployment
aws logs tail /aws/lambda/defillama-prod-api --follow
```

### Environment Configuration

**Serverless Stages**:
- `dev` - Development environment
- `prod` - Production environment

**Environment Variables**:
```yaml
# serverless.yml
provider:
  environment:
    tableName: ${self:custom.tableName}
    NODE_ENV: ${opt:stage, 'dev'}
    
custom:
  tableName:
    dev: dev-table
    prod: prod-table
```

## 📚 Additional Resources

### Documentation
- **API Documentation**: https://defillama.com/docs/api
- **Coin Prices API**: https://docs.llama.fi/coin-prices-api
- **Serverless Framework**: https://www.serverless.com/framework/docs/

### Community
- **GitHub Issues**: Report bugs and feature requests
- **Discord**: Join the DeFiLlama community
- **Twitter**: Follow @DefiLlama for updates

### Contributing
1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Submit a pull request

---

*This development guide was generated using BMAD Method v6.0.0-alpha.0 codebase analysis.*
